
# Creating a browser application using npm and emlite

This guide assumes you're targeting wasm32-wasi. But you can modify it for whichever actual target you might need.

Initialize your project:
```bash
npm init -y
npm install emlite @bjorn3/browser_wasi_shim
npm install webpack webpack-cli http-server --save-dev
mkdir src
touch src/index.js
touch src/main.c
mkdir dist
touch dist/index.html
touch CMakeLists.txt
```

Modify your package.json:
- Point the entry `main` to `./src/index.js`, and change the type to "module":
```json
"main": "src/index.js",
"type": "module",
```
- Add commands to invoke cmake, webpack and http-server in your `scripts` entry:
```json
  "scripts": {
    "cmake": "cmake -Bbin -DCMAKE_TOOLCHAIN_FILE=$WASI_SDK/share/cmake/wasi-sdk.cmake && cmake --build bin && cp bin/main.wasm ./dist",
    "build": "webpack",
    "serve": "http-server ./dist"
  },
```

In your dist/index.html (note that main.js is generated by webpack in the dist folder):
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script type="module" src="./main.js"></script>
</body>
</html>
```

In your src/index.js:
```javascript
import { Emlite } from "emlite";
import { WASI, File, OpenFile, ConsoleStdout } from "@bjorn3/browser_wasi_shim";

async function main() {
    let fds = [
        new OpenFile(new File([])), // 0, stdin
        ConsoleStdout.lineBuffered(msg => console.log(`[WASI stdout] ${msg}`)), // 1, stdout
        ConsoleStdout.lineBuffered(msg => console.warn(`[WASI stderr] ${msg}`)), // 2, stderr
    ];
    let wasi = new WASI([], [], fds);
    const emlite = new Emlite();
    const bytes = await emlite.readFile(new URL("./main.wasm", import.meta.url));
    let wasm = await WebAssembly.compile(bytes);
    let inst = await WebAssembly.instantiate(wasm, {
        "wasi_snapshot_preview1": wasi.wasiImport,
        "env": emlite.env,
    });
    emlite.setExports(inst.exports);
    wasi.start(inst);
    // call an exported function
    // inst.exports.some_func();
}

await main();
```

In your src/main.c:
```c++
#include <emlite/emlite.h>

int main() {
    emlite_init_handle_table();
    em_Val console = em_Val_global("console");
    em_Val_call(console, "log", 1, em_Val_from_string("200"));
    emlite_reset_object_map();
}
```

In your CMakeLists.txt:
```cmake
cmake_minimum_required(VERSION 3.20)
project(projname)

include(FetchContent)

FetchContent_Declare(
    emlite
    GIT_REPOSITORY https://github.com/emlite/emlitec.git
    GIT_TAG main
    GIT_SHALLOW True
)

FetchContent_MakeAvailable(emlite)

add_executable(main src/main.c)
target_link_libraries(main PRIVATE emlitec::emlitec)
set_target_properties(main PROPERTIES LINKER_LANGUAGE CXX SUFFIX .wasm LINK_FLAGS "-Wl,--no-entry,--allow-undefined,--export-dynamic,--export-if-defined=main,--export-table,--import-memory,--export-memory,--strip-all")
```

Make sure to export WASI_SDK to point to your wasi-sdk directory.

```bash
npm run cmake
npm run build
npm run serve
```
